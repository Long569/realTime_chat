<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=520, initial-scale=1.0, interactive-widget=resizes-content">
    <title>DrawRT 3.0</title>
    <link href="image/favicon.png" rel="shortcut icon">
    <link href="css/app.css" rel="stylesheet">
    <style>
        #box {
            border: 1px solid #999;
            width: 35px;
            height: 35px;
            
            display: grid;
            place-items: center;
        }

        #pen {
            background: #000;
            border: 1px solid #000;
            border-radius: 50%;
            width: 5px;
            height: 5px;
        }

        #panel {
            width: 500px;
            margin-bottom: 10px;
            
            display: flex;
        }

        #size {
            flex: 1;
        }

        #color {
            width: 60px;
            height: auto;
        }

        #canvas {
            display: block;
            border: 1px solid #999;
            
            /* TODO */
            cursor: url(image/pencil-down.png) 0 32, pointer;
            user-select: none;
            touch-action: none;
        }

        .active {
            outline: 5px dashed red;
        }
    </style>
</head>

<body>
    <header>
        <h1><a href="/">DrawRT 3.0</a></h1>
    </header>

    <main hidden>
        <div id="panel">
            <div id="box">
                <div id="pen"></div>
            </div>

            <input type="range" id="size" min="1" max="30" step="1" value="5" list="ticks">
            <datalist id="ticks">
                <option value="5">
                <option value="10">
                <option value="15">
                <option value="20">
                <option value="25">
                <option value="30">
            </datalist>

            <input type="color" id="color" list="colors">
            <datalist id="colors">
                <option value="#ff0000">
                <option value="#ffa500">
                <option value="#ffff00">
                <option value="#008000">
                <option value="#0000ff">
                <option value="#4b0082">
                <option value="#ee82ee">
                <option value="#000000">
                <option value="#ffffff">
                <option value="#808080">
            </datalist>

            <button id="clear">üóëÔ∏è</button>

            <button id="image">üñºÔ∏è</button>
            <input type="file" id="file" accept="image/*" hidden>

            <button id="download">üíæ</button>
        </div>

        <canvas id="canvas" width="500" height="500"></canvas>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.slim.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        // (1) Interactive UI Events ==============================================================
        $('#size').on('input', e => {
            const size = $('#size').val();
            $('#pen').width(size).height(size);
        });

        $('#color').on('input', e => {
            const color = $('#color').val();
            $('#pen').css('background', color);
        });

        $('#size, #color').trigger('input');

        $('#canvas').on('wheel', e => {
            e.preventDefault();
            if (e.originalEvent.deltaY < 0) {
                $('#size')[0].stepUp();
            }
            else {
                $('#size')[0].stepDown();
            }
            $('#size').trigger('input');
        });

        $(document).keydown(e => {
            if (e.originalEvent.repeat) return;
            switch (e.key) {
                case '0': $('#clear').click(); break;
                case '1': $('#color').val('#ff0000'); break;
                case '2': $('#color').val('#ffa500'); break;
                case '3': $('#color').val('#ffff00'); break;
                case '4': $('#color').val('#008000'); break;
                case '5': $('#color').val('#0000ff'); break;
                case '6': $('#color').val('#4b0082'); break;
                case '7': $('#color').val('#ee82ee'); break;
                case '8': $('#color').val('#000000'); break;
                case '9': $('#color').val('#ffffff'); break;
            }
            $('#color').trigger('input');
        });

        // (2) General Functions ==================================================================
        const can = $('#canvas')[0];
        const ctx = can.getContext('2d');

        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.shadowBlur = 1;
        clear();

        function clear() {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, can.width, can.height);
        }

        // drawLine({ x: 10, y: 10 }, { x: 100, y: 100 }, 10, 'red')

        function drawLine(a, b, size, color) {
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.lineTo(b.x, b.y);
            ctx.lineWidth = size;
            ctx.strokeStyle = color;
            ctx.shadowColor = color;
            ctx.stroke();
        }

        // drawImage('image/favicon.png');

        // Convert to promise (awaitable function)
        function drawImage(url) {
            return new Promise(resolve => {
                const img = new Image();
                img.onload = e => {
                    ctx.drawImage(img, 0, 0);
                    resolve();
                };
                img.src = url;
            });
        }

        // drawCurve({ x: 0, y: 0 }, { x: 250, y: 500 }, { x: 500, y: 0 }, 10, 'red');

        function drawCurve(a, b, c, size, color) {
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.quadraticCurveTo(b.x, b.y, c.x, c.y);
            ctx.lineWidth = size;
            ctx.strokeStyle = color;
            ctx.shadowColor = color;
            ctx.stroke();
        }

        function mid(a, b) {
            return {
                x: (a.x + b.x) / 2,
                y: (a.y + b.y) / 2,
            };
        }

        function cropAndDrawImage(f) {
            if (f && f.type.startsWith('image/')) {
                crop(f, can.width, can.height, 'dataURL', 'image/webp')
                    .then(url => {
                        drawImage(url);
                        con.invoke('SendImage', url);
                    });
            }
        }

        function sleep(ms) {
            return new Promise(resolve => {
                setTimeout(resolve, ms);
            });
        }

        // (3) Draw Events ========================================================================
        let arr = [];

        $('#canvas').on('pointerdown pointermove pointerout', e => {
            if (e.buttons == 1 && e.originalEvent.isPrimary) {
                const size = $('#size').val() * 1;
                const color = $('#color').val();

                // Calculate start point
                if (arr.length == 0) {
                    arr.push({
                        x: e.offsetX - e.originalEvent.movementX,
                        y: e.offsetY - e.originalEvent.movementY,
                    });
                }

                // Add new point
                arr.push({
                    x: e.offsetX,
                    y: e.offsetY,
                });

                // Keep last 3 points
                arr = arr.slice(-3);

                // Draw line
                if (arr.length == 2) {
                    const a = arr[0];
                    const b = mid(arr[0], arr[1]);
                    drawLine(a, b, size, color);
                    con.invoke('SendLine', a, b, size, color);
                }
                // Draw curve
                else if (arr.length == 3) {
                    const a = mid(arr[0], arr[1]);
                    const b = arr[1];
                    const c = mid(arr[1], arr[2]);
                    drawCurve(a, b, c, size, color);
                    con.invoke('SendCurve', a, b, c, size, color);
                }
            }
        });

        $('#canvas').on('pointerup pointerout', e => {
            const size = $('#size').val() * 1;
            const color = $('#color').val();

            // Keep last 2 points
            arr = arr.slice(-2);

            // Draw line
            if (arr.length == 2) {
                const a = mid(arr[0], arr[1]);
                const b = arr[1];
                drawLine(a, b, size, color);
                con.invoke('SendLine', a, b, size, color);
            }

            arr = [];
        });

        // --------------------------------------

        $('#clear').click(e => {
            clear();
            con.invoke('SendClear');
        });

        $('#image').click(e => $('#file').click());

        $('#file').change(e => {
            const f = e.target.files[0];
            cropAndDrawImage(f);
            e.target.value = null;
        });

        $('#download').click(e => {
            const a = $('<a>')[0];
            a.href = can.toDataURL('image/png');
            a.download = Date.now() + '.png';
            a.click();
        });

        $('#canvas').on('contextmenu', e => {
            e.preventDefault();
        });

        // Drag and drop
        $('#canvas').on('dragenter dragover', e => {
            e.preventDefault();
            $('#canvas').addClass('active');
        });

        $('#canvas').on('dragleave drop', e => {
            e.preventDefault();
            $('#canvas').removeClass('active');
        });

        $('#canvas').on('drop', e => {
            e.preventDefault();
            const f = e.originalEvent.dataTransfer.files[0];
            cropAndDrawImage(f);
        });

        // (4) SignalR ============================================================================
        const con = new signalR.HubConnectionBuilder()
            .withUrl('/hub')
            .build();

        con.onclose(err => {
            alert('Disconnected');
            location = '/';
        });
        
        con.on('ReceiveLine' , drawLine);
        con.on('ReceiveCurve', drawCurve);
        con.on('ReceiveImage', drawImage);
        con.on('ReceiveClear', clear);

        con.on('ReceiveCommands', async commands => {
            for (const cmd of commands) {
                await window[cmd.name](...cmd.param);
                await sleep(1);
            }
        });

        con.start().then(() => $('main').show());
    </script>
</body>
</html>